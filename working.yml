---
- name: Sync Cathexis User Database
  hosts: other_servers
  become: false 
  vars:
    db_path: "/home/ubuntu/nvr/users.db"
  tasks:

    - name: Ensure sqlite3 is installed
      package:
        name: sqlite3
        state: present

    - name: Check if Users and Password tables exist
      command: sqlite3 "{{ db_path }}" "SELECT name FROM sqlite_master WHERE type='table' AND (name='users' OR name='passwords');"
      register: db_checksqlite3
      changed_when: false
      failed_when: false

    - name: Copy data if doesn't exist
      when: "'users' not in db_checksqlite3.stdout"
      synchronize:
        src: "{{ db_path }}"
        dest: "{{ db_path }}"
        mode: push
      delegate_to: gittest

- name: Sync users from gittest to server1 and server2
  hosts: all
  become: yes
  vars:
    sh_path: "/home/ubuntu/nvr/sync.py"
  tasks:

     - name: Copy script to remote machine
       copy:
         src: /home/ubuntu/userdb/sync.py
         dest: /home/ubuntu/nvr/sync.py
         mode: '0777'

     - name: Execute script
       command: python3  {{ sh_path }} {{ hostvars['gittest']['db_path'] }} {{ db_path }}
       register: script_output

     - name: script output  
       debug:
        var: script_output

